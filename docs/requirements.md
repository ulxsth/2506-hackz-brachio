# 要件定義書
## ITタイピングゲーム
### システム概要
#### システム名
TYPE 2 LIVE

#### システムの概要
特定の制約条件に沿ったIT用語をタイピングして得点を競う、リアルタイムマルチプレイヤーゲーム

---

### 機能要件

#### ゲームプレイ機能

##### タイピング機能
- **機能概要**: プレイヤーがIT用語を入力する機能
- **入力方式**: キーボード入力
- **入力検証**: 辞書との照合による正誤判定
- **リアルタイム表示**: 入力中の文字をリアルタイム表示

##### 得点システム
- **得点計算式**: `獲得得点 = 単語文字数 × 難易度(1-10) × 制約係数の積 × コンボ数`
- **得点表示**: リアルタイムでの得点更新表示
- **順位表示**: プレイヤー順位のリアルタイム表示

##### 制約システム
- **制約タイプ**:
  - 文字制約
    - 特定アルファベットを含む/含まない
    - 特定アルファベットから始まる/終わる
  - カテゴリー制約（技術分野の指定）
  - 文字数制約（N文字以上/以下）
- **制約表示**: 現在の制約条件を画面上に明示
- **制約変更**: パス機能による制約の変更（クールダウン10秒）

##### コンボシステム
- **コンボ管理**: 連続正解回数の管理
- **コンボ表示**: 現在のコンボ数をリアルタイム表示
- **コンボリセット条件**:
  - 10秒間入力なし
  - 不正解入力
  - パス使用時

##### ゲーム進行管理
- **ゲーム開始**: ホストによるゲーム開始操作
- **制限時間管理**: ゲーム時間の計測と表示
- **ゲーム終了**: 制限時間到達時の自動終了
- **結果表示**: 最終順位と各プレイヤーの得点表示
- **リアルタイム同期**: Supabase Realtimeによる状態同期
- **Lambda連携**: AWS Lambda関数からSupabase Realtime APIへの状態更新

#### マッチング・ルーム機能

##### ルーム作成機能
- **ルーム作成**: ホストによるルーム作成
- **あいことば設定**: ルーム参加用のパスワード設定
- **ルーム設定**: ゲーム時間、プレイヤー数上限などの設定

##### ルーム参加機能
- **ルーム検索**: あいことばによるルーム検索
- **ルーム参加**: 参加者のルーム入室
- **参加者表示**: ルーム内参加者一覧の表示

##### ルーム管理機能
- **参加者管理**: 参加者の入退室管理
- **ホスト権限**: ゲーム開始権限の管理
- **ルーム状態管理**: 待機中/ゲーム中の状態管理

#### 辞書・データ管理機能

##### IT用語辞書
- **用語データベース**: IT用語の保存・管理
- **カテゴリー分類**: Web、DB、AI、セキュリティ等の分類
- **難易度設定**: 各用語の難易度（1-10）設定
- **検索機能**: 制約条件による用語検索

##### 制約データ管理
- **制約パターン**: 事前定義された制約組み合わせ
- **制約係数**: 各制約の難易度係数管理
- **動的難易度調整**: プレイヤーの成績に応じた制約選択

#### ゲーム同期システム設計
##### 段階的準備確認フロー
```mermaid
graph TB
    A[ゲーム開始要求] --> B[サーバー時刻同期開始]
    B --> C[準備フェーズ開始<br/>(最大60秒)]
    C --> D[アセット読み込み]
    D --> E[ネットワーク確認]
    E --> F[UI準備完了]
    F --> G{全員準備完了?}
    G -->|Yes| H[カウントダウン開始<br/>5秒]
    G -->|No<br/>強制進行
    I --> H
    H --> J[サーバー指定時刻で<br/>🚀同時開始]
```

##### 実装戦略
1. **時刻同期機能**
   - PostgreSQL関数: `get_server_time()` でサーバー時刻取得
   - 30秒間隔での時差補正
   - ネットワーク遅延の動的補正

2. **準備状態管理**
   - `player_ready_states` テーブルでリアルタイム管理
   - アセット読み込み、ネットワーク、UI準備の段階的確認
   - Supabase Realtimeでの状態同期


---

### 非機能要件

#### 性能要件
- **レスポンス時間**: タイピング入力から判定まで100ms以内
- **同時接続数**: 最大100プレイヤーの同時接続対応
- **リアルタイム更新**: 得点・順位の500ms以内更新
- **Lambda Cold Start**: 100ms以内の応答を目指す
- **Supabase Realtime**: WebSocket接続による即座の状態同期

#### 拡張性要件
- **水平スケーリング**: AWS Lambdaの自動スケーリング対応
- **辞書拡張**: 新しいIT用語の追加機能
- **サーバレス**: コスト効率の良いサーバレス構成
- **リアルタイム**: Supabase Realtimeの高可用性活用

---

### 技術要件

#### システム構成
- **フロントエンド**: Next.js 14 (CSR + App Router) + TypeScript
- **バックエンド**: AWS Lambda + TypeScript (サーバレス)
- **リアルタイム通信**: Supabase Realtime
- **データベース**: Supabase PostgreSQL
- **API Gateway**: AWS API Gateway (REST API)

#### 開発環境
- **開発言語**: TypeScript
- **パッケージマネージャー**: pnpm
- **テストフレームワーク**: Jest + React Testing Library
- **コードフォーマット**: Prettier + ESLint
- **サーバレス**: AWS SAM (Serverless Application Model)
- **リアルタイムDB**: Supabase

#### インフラ管理
- **ホスティング**: Vercel (フロントエンド)
- **サーバレス**: AWS Lambda
- **API管理**: AWS API Gateway
- **データベース**: Supabase PostgreSQL
- **リアルタイム**: Supabase Realtime
- **CDN**: AWS CloudFront + Vercel Edge Network
- **認証**: Supabase Auth
- **IaC**: Terraform
- **CI/CD**: GitHub Actions
- **監視**: AWS CloudWatch
- **ログ**: AWS CloudWatch Logs
- **シークレット管理**: AWS Systems Manager Parameter Store

#### レンダリング戦略
- **静的ページ**: SSG (トップページ、利用規約等)
- **ゲーム画面**: CSR (リアルタイム性重視)
- **SEO不要ページ**: CSR (ルーム、ゲームプレイ、結果画面)

#### 外部連携
- **リアルタイム通信**: Supabase Realtime (WebSocket代替)
- **Lambda統合**: AWS Lambda → Supabase Realtime API連携
- **辞書API**: IT用語データの取得（必要に応じて）
- **認証**: Supabase Auth (OAuth 2.0対応)

---

### アーキテクチャ詳細

#### サーバレス構成
- **API Gateway + Lambda**: RESTful APIエンドポイント
- **Lambda関数構成**:
  - `createRoom`: ルーム作成処理
  - `joinRoom`: ルーム参加処理
  - `startGame`: ゲーム開始処理
  - `submitWord`: 単語提出・得点計算処理
  - `gameTimer`: ゲーム時間管理処理

#### リアルタイム通信フロー
1. **フロントエンド**: Supabase Realtimeに直接接続
2. **Lambda関数**: ゲーム状態変更時にSupabase Realtime APIを呼び出し
3. **Supabase Realtime**: 全参加者に状態変更を即座に配信
4. **フロントエンド**: リアルタイムで状態更新を受信・反映

#### データベース設計
- **Supabase PostgreSQL**:
  - `rooms`: ルーム情報
  - `players`: プレイヤー情報
  - `game_sessions`: ゲームセッション
  - `word_submissions`: 単語提出履歴
  - `it_terms`: IT用語辞書

---

### 画面要件

#### メイン画面構成
1. **トップページ**: ゲーム開始・ルーム作成/参加
2. **ルーム待機画面**: 参加者一覧・ゲーム設定
3. **ゲームプレイ画面**: タイピング入力・得点表示・制約表示
4. **結果画面**: 最終順位・統計情報

#### UI/UX要件
- **視覚的フィードバック**: 正解/不正解の即座な視覚的表現

---

### 成功指標

#### 技術指標
- **ゲーム完走率**: 95%以上
- **レスポンス時間**: 平均100ms以内

#### ユーザー体験指標
- **ゲーム満足度**: テストプレイでの高評価
- **操作性**: 直感的なUI操作の実現
- **競技性**: 適切な難易度バランスの実現
