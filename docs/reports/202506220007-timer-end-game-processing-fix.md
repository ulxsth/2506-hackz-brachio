# ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†æ™‚ã®ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†ä¸å‚™ä¿®æ­£ - å®Ÿè£…å®Œäº†å ±å‘Š ğŸ“‹

## ğŸ“… å®Ÿè£…æ—¥æ™‚
2025å¹´6æœˆ22æ—¥

## âœ… å®Ÿè£…å®Œäº†é …ç›®

### 1. `handleTimerEndGame`é–¢æ•°ã®å®Ÿè£…
**ãƒ•ã‚¡ã‚¤ãƒ«**: `/frontend/app/game/page.tsx`
**æ–°è¦è¿½åŠ **: 527-557è¡Œç›®

```tsx
const handleTimerEndGame = async () => {
  try {
    if (!currentRoom?.id || !user?.id || !currentRoom?.host_id) {
      console.error('âŒ ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†: å¿…è¦ãªæƒ…å ±ãŒä¸è¶³');
      const roomId = currentRoom?.id || 'unknown';
      router.push(`/result?roomId=${roomId}`);
      return;
    }

    // ãƒ›ã‚¹ãƒˆã®ã¿ãŒã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†ã‚’å®Ÿè¡Œ
    if (user.id === currentRoom.host_id) {
      console.log('ğŸ ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†: ãƒ›ã‚¹ãƒˆãŒã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†ã‚’å®Ÿè¡Œ');
      const result = await forceEndGame();
      
      if (!result.success) {
        console.error('âŒ ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†: ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†å¤±æ•—', result.error);
      } else {
        console.log('âœ… ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†: ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†æˆåŠŸ');
      }
    } else {
      console.log('ğŸ‘¥ ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†: éãƒ›ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼');
    }
    
    // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒçµæœãƒšãƒ¼ã‚¸ã«é·ç§»
    router.push(`/result?roomId=${currentRoom.id}`);
  } catch (error) {
    console.error('âŒ ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†ã‚¨ãƒ©ãƒ¼:', error);
    const roomId = currentRoom?.id || 'unknown';
    router.push(`/result?roomId=${roomId}`);
  }
};
```

### 2. ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†æ™‚ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ä¿®æ­£
**ãƒ•ã‚¡ã‚¤ãƒ«**: `/frontend/app/game/page.tsx`
**å¤‰æ›´è¡Œ**: 497-500è¡Œç›®

**ä¿®æ­£å‰**:
```tsx
if (timeLeft <= 0) {
  const roomId = currentRoom?.id || 'unknown';
  router.push(`/result?roomId=${roomId}`);
  return;
}
```

**ä¿®æ­£å¾Œ**:
```tsx
if (timeLeft <= 0) {
  handleTimerEndGame();
  return;
}
```

### 3. forceEndGame importè¿½åŠ 
**ãƒ•ã‚¡ã‚¤ãƒ«**: `/frontend/app/game/page.tsx`
**å¤‰æ›´è¡Œ**: 7è¡Œç›®
```tsx
import { submitWord, updatePlayerScore, startGame, forceEndGame } from '@/lib/room';
```

## ğŸ” æ¤œè¨¼çµæœ

### TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ« âœ…
- ã‚¨ãƒ©ãƒ¼ãªã—
- å‹ãƒã‚§ãƒƒã‚¯å®Œäº†

### Next.jsãƒ“ãƒ«ãƒ‰ âœ…
- ãƒ“ãƒ«ãƒ‰æˆåŠŸï¼ˆ7.0ç§’ã§å®Œäº†ï¼‰
- å…¨ãƒšãƒ¼ã‚¸ã®é™çš„ç”ŸæˆæˆåŠŸ
- ã‚²ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º: 13.5kBï¼ˆ+0.2kBï¼‰

### å®Ÿè£…è¨­è¨ˆã®æ¤œè¨¼ âœ…

#### æ¨©é™åˆ¶å¾¡
- **ãƒ›ã‚¹ãƒˆã®ã¿**: `forceEndGame` RPCå®Ÿè¡Œ
- **å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼**: çµæœãƒšãƒ¼ã‚¸é·ç§»
- **useRoom**ãƒ•ãƒƒã‚¯çµŒç”±ã§é©åˆ‡ãªæ¨©é™ãƒã‚§ãƒƒã‚¯

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- å¿…è¦æƒ…å ±ä¸è¶³æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- RPCå¤±æ•—æ™‚ã®ãƒ­ã‚°å‡ºåŠ›
- ä¾‹å¤–ç™ºç”Ÿæ™‚ã®å®‰å…¨ãªé·ç§»

#### åŒæœŸå‡¦ç†
- ãƒ›ã‚¹ãƒˆãŒRPCå®Ÿè¡Œ â†’ ãƒ«ãƒ¼ãƒ `status='finished'`æ›´æ–°
- Supabaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«çŠ¶æ…‹é…ä¿¡
- å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒåŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§çµæœãƒšãƒ¼ã‚¸é·ç§»

## ğŸ“Š ä¿®æ­£å‰å¾Œã®æ¯”è¼ƒ

### ä¿®æ­£å‰ã®å•é¡Œãƒ•ãƒ­ãƒ¼ âŒ
1. `timeLeft <= 0` â†’ ç›´æ¥é·ç§»
2. ãƒ«ãƒ¼ãƒ `status`æœªæ›´æ–°ï¼ˆ`waiting`ã®ã¾ã¾ï¼‰
3. çµæœãƒšãƒ¼ã‚¸ã§`.eq('status', 'finished')`æ¤œç´¢ â†’ 0ä»¶
4. ã‚¨ãƒ©ãƒ¼: "PGRST116"

### ä¿®æ­£å¾Œã®æ­£å¸¸ãƒ•ãƒ­ãƒ¼ âœ…
1. `timeLeft <= 0` â†’ `handleTimerEndGame()`
2. ãƒ›ã‚¹ãƒˆãŒ`forceEndGame()` â†’ RPC â†’ `status='finished'`æ›´æ–°
3. å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é·ç§» â†’ çµæœãƒšãƒ¼ã‚¸ã§æ¤œç´¢æˆåŠŸ
4. ã‚²ãƒ¼ãƒ çµæœæ­£å¸¸è¡¨ç¤º

## ğŸ”„ ä¸€è²«æ€§ã®ç¢ºä¿

### å…¨ã¦ã®çµ‚äº†ãƒ‘ã‚¿ãƒ¼ãƒ³ã§çµ±ä¸€å‹•ä½œ
1. **æ‰‹å‹•çµ‚äº†**: `forceEndGame` â†’ `status`æ›´æ–° â†’ çµæœè¡¨ç¤º âœ…
2. **ãƒ«ãƒ¼ãƒ çŠ¶æ…‹å¤‰æ›´**: `status`æ›´æ–° â†’ çµæœè¡¨ç¤º âœ…
3. **ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†**: `forceEndGame` â†’ `status`æ›´æ–° â†’ çµæœè¡¨ç¤º âœ… **ã€ä¿®æ­£å®Œäº†ã€‘**

## ğŸ› ï¸ æŠ€è¡“çš„è©³ç´°

### useRoomãƒ•ãƒƒã‚¯æ´»ç”¨
- `useRoom`ã®`forceEndGame`ã‚’ä½¿ç”¨ï¼ˆå¼•æ•°ãªã—ï¼‰
- å†…éƒ¨ã§é©åˆ‡ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šã¨æ¨©é™ãƒã‚§ãƒƒã‚¯
- ä¸€è²«ã—ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### éåŒæœŸå‡¦ç†
- `handleTimerEndGame`ã‚’`async`é–¢æ•°ã¨ã—ã¦å®Ÿè£…
- `await forceEndGame()`ã§ç¢ºå®Ÿãªå‡¦ç†å®Œäº†å¾…æ©Ÿ
- ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚é©åˆ‡ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

### ãƒ­ã‚°å‡ºåŠ›
- ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ã§å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’è¿½è·¡å¯èƒ½
- ãƒ›ã‚¹ãƒˆ/éãƒ›ã‚¹ãƒˆã®å‹•ä½œã‚’æ˜ç¢ºã«åŒºåˆ¥
- æˆåŠŸ/å¤±æ•—ã®è©³ç´°ãƒ­ã‚°

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œæ”¹å–„

### ä¿®æ­£å‰ã®å•é¡Œ âŒ
1. ã‚¿ã‚¤ãƒãƒ¼çµ‚äº† â†’ çµæœãƒšãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼
2. "ã‚²ãƒ¼ãƒ çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"è¡¨ç¤º
3. ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£æ‚ªåŒ–

### ä¿®æ­£å¾Œã®å‹•ä½œ âœ…
1. ã‚¿ã‚¤ãƒãƒ¼çµ‚äº† â†’ æ­£å¸¸ãªçµæœãƒšãƒ¼ã‚¸è¡¨ç¤º
2. å…¨ã¦ã®ã‚²ãƒ¼ãƒ çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
3. ä¸€è²«ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹

## ğŸ”„ Gitç®¡ç†

### ã‚³ãƒŸãƒƒãƒˆæƒ…å ±
```
fix: add proper game end processing for timer expiration

- Add handleTimerEndGame function to handle timer end scenarios
- Host executes forceEndGame RPC to update room status to 'finished'
- All players navigate to result page with proper roomId
- Ensure consistent game end processing across manual and timer scenarios
- Fix result page data retrieval by ensuring room status is updated

Resolves: Timer end game processing missing room status update
```

## ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. **å®Ÿç’°å¢ƒãƒ†ã‚¹ãƒˆ**: ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†â†’çµæœãƒšãƒ¼ã‚¸ã®å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆ
2. **ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ†ã‚¹ãƒˆ**: è¤‡æ•°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã®åŒæœŸç¢ºèª
3. **å›å¸°ãƒ†ã‚¹ãƒˆ**: æ‰‹å‹•çµ‚äº†ã®å‹•ä½œã«å½±éŸ¿ãŒãªã„ã“ã¨ã‚’ç¢ºèª

## ğŸ¯ çµè«–
**ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†æ™‚ã®ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†ä¸å‚™ä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸã€‚**

- âœ… ãƒ«ãƒ¼ãƒ çŠ¶æ…‹ã®é©åˆ‡ãªæ›´æ–°
- âœ… çµæœãƒšãƒ¼ã‚¸ã§ã®æ­£å¸¸ãªãƒ‡ãƒ¼ã‚¿å–å¾—
- âœ… å…¨ã¦ã®çµ‚äº†ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ä¸€è²«ã—ãŸå‹•ä½œ
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨æ¨©é™åˆ¶å¾¡ã®é©åˆ‡ãªå®Ÿè£…

ã“ã‚Œã§ã€ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†æ™‚ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ­£å¸¸ã«ã‚²ãƒ¼ãƒ çµæœã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼ğŸš€
