# 🎯 リアルタイムランキング同期問題 調査レポート

## 概要
- 問題: 「ホストのみが正しいランキング更新を受け取る」現象の原因調査
- 対象: `frontend/app/game/page.tsx`（ゲーム画面）、`useRoom`（プレイヤー情報・リアルタイム購読）、`lib/room.ts`（DB更新・購読）

---

## 1. 現象の整理
- ホスト: 正しくランキングが更新される
- 非ホスト: 他プレイヤーのスコアがリアルタイムで反映されない
- ただし、全員がSupabaseの`room_players`テーブルのUPDATEイベントを購読している設計

---

## 2. コード構造の要点
- `useRoom`で`players`（全プレイヤー情報）を管理し、UPDATEイベントで`playersAtom`を更新
- `page.tsx`では`players`と`myScore`を合成して`rankedPlayers`を生成
- `myScore`はローカルStateで管理し、DB更新後も即時反映
- 他プレイヤーのスコアは`players`経由でのみ反映

---

## 3. 仮説と検証ポイント
### 仮説A: 非ホストのUPDATE購読が正しく動作していない
- → `useRoom`の購読ロジックがホスト/非ホストで分岐していないか？
- → Supabaseのリアルタイムチャネルが全員で正しくsubscribeされているか？

### 仮説B: DBのスコア更新が非ホストから反映されていない
- → `updatePlayerScore`の呼び出しが全員で正しく行われているか？
- → DBの`room_players`テーブルのUPDATEが発火しているか？

### 仮説C: Atom/Stateの更新が非ホストで止まっている
- → `playersAtom`の更新トリガーが正しく発火しているか？
- → useEffect等で購読解除や初期化が早期に走っていないか？

---

## 4. 追加調査ポイント
- SupabaseのRLS/権限で非ホストのUPDATEイベントがブロックされていないか
- DBのUPDATEが実際に反映されているか（DBコンソールで確認）
- 非ホストの購読イベントのデバッグログ出力

---

## 5. 次のアクション案
1. 非ホストで`room_players`のUPDATEイベントが受信できているか、デバッグログを追加
2. `updatePlayerScore`実行後、DBの値が即時反映されているか確認
3. Atom/Stateの更新が全員で発火しているか確認

---

## まとめ
- 現状、設計上は全員が同じ購読をしているはずだが、どこかで「非ホストだけ」購読 or State更新が止まっている可能性が高い
- 上記の仮説に沿ってデバッグを進めることで、根本原因の特定が期待できる

---

## ユーザが次に取れる行動
- このレポートをもとに、非ホストでのリアルタイムイベント受信状況をデバッグする
- 必要に応じて、`useRoom`や`lib/room.ts`にデバッグログを追加し、イベントの流れを追跡する
- 追加調査や実装修正が必要な場合は「実装」や「デバッグ」と指示してください

---

🕵️‍♂️✨
