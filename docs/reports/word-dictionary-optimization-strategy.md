# å˜èªãƒ‡ãƒ¼ã‚¿åœ§ç¸®ãƒ»äº‹å‰å‡¦ç†ãƒ»Supabase Storageæ´»ç”¨èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ

## èª¿æŸ»æ¦‚è¦
ITã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚²ãƒ¼ãƒ ã«ãŠã‘ã‚‹4000èªè¦æ¨¡ã®å˜èªè¾æ›¸ãƒ‡ãƒ¼ã‚¿ã®åŠ¹ç‡çš„ãªç®¡ç†ãƒ»é…ä¿¡æ–¹å¼ã«ã¤ã„ã¦èª¿æŸ»ã—ã€æœ€é©ãªå®Ÿè£…æ¡ˆã‚’ææ¡ˆã™ã‚‹ã€‚

## ç¾åœ¨ã®èª²é¡Œ
1. **ã‚¹ã‚±ãƒ¼ãƒ«å•é¡Œ**: ç¾åœ¨29èª â†’ ç›®æ¨™4000èªï¼ˆç´„138å€ã®å¢—åŠ ï¼‰
2. **ãƒ¡ãƒ¢ãƒªè² è·**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®å¤§å®¹é‡è¾æ›¸ãƒ‡ãƒ¼ã‚¿ä¿æŒ
3. **æ¤œç´¢æ€§èƒ½**: åˆ¶ç´„æ¡ä»¶ï¼ˆæŒ‡å®šæ–‡å­—ã‚’å«ã‚€ï¼‰ã«å¯¾ã™ã‚‹é«˜é€Ÿæ¤œç´¢
4. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è² è·**: å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚é–“
5. **ãƒ‡ãƒ¼ã‚¿æ›´æ–°**: è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ãƒ»ä¿®æ­£æ™‚ã®åŠ¹ç‡çš„ãªæ›´æ–°

## æŠ€è¡“è¦ä»¶åˆ†æ

### 1. ãƒ‡ãƒ¼ã‚¿é‡è¦‹ç©ã‚‚ã‚Š
- **ç¾åœ¨**: 29èª Ã— å¹³å‡50æ–‡å­—/èª â‰ˆ 1.5KB
- **ç›®æ¨™**: 4000èª Ã— å¹³å‡50æ–‡å­—/èª â‰ˆ 200KB
- **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿**: é›£æ˜“åº¦ãƒ»èª¬æ˜ãƒ»ã‚¨ã‚¤ãƒªã‚¢ã‚¹å«ã‚ã¦ â‰ˆ 400KB
- **ç·åˆ**: ç´„600KBï¼ˆéåœ§ç¸®æ™‚ï¼‰

### 2. åˆ¶ç´„æ¤œç´¢ã®æœ€é©åŒ–è¦ä»¶
- **åˆ¶ç´„**: æŒ‡å®šæ–‡å­—ã‚’å«ã‚€å˜èªã®é«˜é€Ÿæ¤œç´¢
- **ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ26æ–‡å­—**: å„æ–‡å­—ã”ã¨ã®å˜èªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- **æ¤œç´¢æ™‚é–“**: O(1)ã¾ãŸã¯ O(log n)ãƒ¬ãƒ™ãƒ«ã®æ€§èƒ½è¦æ±‚

## ææ¡ˆã™ã‚‹è§£æ±ºæ–¹å¼

### æ–¹å¼1: ãƒã‚¤ãƒŠãƒªåœ§ç¸® + Supabase Storage
```javascript
// ãƒ‡ãƒ¼ã‚¿æ§‹é€ ä¾‹
{
  "metadata": {
    "version": "1.0.0",
    "wordCount": 4000,
    "lastUpdated": "2025-01-20T10:00:00Z"
  },
  "letterIndex": {
    "a": [0, 15, 23, 45, ...], // 'a'ã‚’å«ã‚€å˜èªã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    "b": [2, 18, 34, ...],
    // ... å…¨26æ–‡å­—åˆ†
  },
  "words": [
    {
      "id": 0,
      "text": "algorithm",
      "romaji": "arugorizu", 
      "difficulty": 3,
      "description": "å•é¡Œè§£æ±ºæ‰‹é †"
    },
    // ... 4000èªåˆ†
  ]
}
```

**åœ§ç¸®æˆ¦ç•¥**:
- gzipåœ§ç¸®ã§ç´„70%å‰Šæ¸› â†’ ç´„180KB
- æ–‡å­—åˆ—ã®é‡è¤‡é™¤å»ï¼ˆdifficultyåãªã©ï¼‰
- æ•°å€¤ã®åŠ¹ç‡çš„ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

### æ–¹å¼2: åˆ†å‰²ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ + é…å»¶èª­ã¿è¾¼ã¿
```javascript
// ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ä¾‹
- words-meta.json.gz (20KB) // åŸºæœ¬æƒ…å ±
- words-a-e.json.gz (60KB)  // a-eæ–‡å­—ã®å˜èª
- words-f-j.json.gz (60KB)  // f-jæ–‡å­—ã®å˜èª
- words-k-o.json.gz (60KB)  // k-oæ–‡å­—ã®å˜èª
- words-p-t.json.gz (60KB)  // p-tæ–‡å­—ã®å˜èª  
- words-u-z.json.gz (40KB)  // u-zæ–‡å­—ã®å˜èª
```

**åˆ©ç‚¹**:
- åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã¯åŸºæœ¬æƒ…å ±ã®ã¿ï¼ˆ20KBï¼‰
- åˆ¶ç´„æ–‡å­—ã«å¿œã˜ã¦å¿…è¦ãªåˆ†å‰²ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å‹•çš„èª¿æ•´

### æ–¹å¼3: IndexedDB + ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
```javascript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚­ãƒ£ãƒƒã‚·ãƒ¥
class WordDictionary {
  constructor() {
    this.indexedDB = null;
    this.memoryCache = new Map();
    this.letterIndex = new Map();
  }

  async initialize() {
    // IndexedDBã‹ã‚‰æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª â†’ å¿…è¦ã«å¿œã˜ã¦æ›´æ–°
    // ãƒ¡ãƒ¢ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰
  }

  async getWordsWithLetter(letter) {
    // 1. ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
    // 2. IndexedDBç¢ºèª  
    // 3. å¿…è¦ã«å¿œã˜ã¦Storageã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  }
}
```

## Supabase Storageã®æ´»ç”¨

### 1. ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®æˆ¦ç•¥
```
supabase-storage/
â”œâ”€â”€ dictionaries/
â”‚   â”œâ”€â”€ v1.0.0/
â”‚   â”‚   â”œâ”€â”€ words-full.json.gz      (ãƒ•ãƒ«è¾æ›¸)
â”‚   â”‚   â”œâ”€â”€ words-meta.json.gz      (ãƒ¡ã‚¿æƒ…å ±)
â”‚   â”‚   â”œâ”€â”€ words-index.json.gz     (æ–‡å­—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹)
â”‚   â”‚   â””â”€â”€ chunks/
â”‚   â”‚       â”œâ”€â”€ words-a-e.json.gz
â”‚   â”‚       â”œâ”€â”€ words-f-j.json.gz
â”‚   â”‚       â””â”€â”€ ...
â”‚   â””â”€â”€ latest -> v1.0.0/           (ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯)
```

### 2. CDNæœ€é©åŒ–
- Supabase Storage â†’ CDNçµŒç”±ã§ã®é«˜é€Ÿé…ä¿¡
- gzipåœ§ç¸® + Brotliåœ§ç¸®å¯¾å¿œ
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé–“è¨­å®šï¼ˆé•·æœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ + ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ï¼‰

### 3. å·®åˆ†æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ 
```javascript
// æ›´æ–°æ¤œå‡º
const currentVersion = localStorage.getItem('dictionaryVersion');
const latestVersion = await fetchLatestVersion();

if (currentVersion !== latestVersion) {
  // å·®åˆ†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ã¾ãŸã¯ ãƒ•ãƒ«æ›´æ–°
  await updateDictionary(currentVersion, latestVersion);
}
```

## äº‹å‰å‡¦ç†ã®è¨­è¨ˆ

### 1. ãƒ“ãƒ«ãƒ‰æ™‚å‡¦ç†
```javascript
// scripts/build-dictionary.js
async function buildDictionary() {
  const rawData = await loadFromSupabase();
  
  // 1. æ–‡å­—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆ
  const letterIndex = buildLetterIndex(rawData);
  
  // 2. æœ€é©åŒ–ï¼ˆé‡è¤‡é™¤å»ã€åœ§ç¸®ï¼‰
  const optimized = optimizeData(rawData);
  
  // 3. åˆ†å‰²ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
  const chunks = splitByLetter(optimized);
  
  // 4. åœ§ç¸® & Supabase Storageã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  await uploadToStorage(chunks);
}
```

### 2. æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆ
```javascript
function buildLetterIndex(words) {
  const index = {};
  
  for (let i = 0; i < words.length; i++) {
    const word = words[i];
    const uniqueLetters = new Set(word.text.toLowerCase());
    
    for (const letter of uniqueLetters) {
      if (!index[letter]) index[letter] = [];
      index[letter].push(i);
    }
  }
  
  return index;
}
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–
```javascript
// WeakMapã‚’æ´»ç”¨ã—ãŸãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢
class OptimizedWordCache {
  constructor() {
    this.wordCache = new WeakMap();
    this.letterCache = new Map();
  }
  
  // ä½¿ç”¨é »åº¦ã®ä½ã„ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•é–‹æ”¾
  cleanupUnusedData() {
    // LRU cache implementation
  }
}
```

### 2. æ¤œç´¢æœ€é©åŒ–
```javascript
// Bloom Filterã«ã‚ˆã‚‹äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
class BloomFilter {
  // å˜èªã®å­˜åœ¨å¯èƒ½æ€§ã‚’é«˜é€Ÿãƒã‚§ãƒƒã‚¯
  // false positiveã¯è¨±å®¹ã€false negativeã¯å›é¿
}

// Trieæ§‹é€ ã«ã‚ˆã‚‹å‰æ–¹ä¸€è‡´æ¤œç´¢
class WordTrie {
  // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ä¸­ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å€™è£œè¡¨ç¤º
}
```

## å®Ÿè£…å„ªå…ˆåº¦

### Phase 1: åŸºæœ¬å®Ÿè£… ğŸš€
1. Supabase Storageã¸ã®é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®
2. gzipåœ§ç¸®ã«ã‚ˆã‚‹åŸºæœ¬çš„ãªå®¹é‡å‰Šæ¸›
3. æ–‡å­—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®äº‹å‰ç”Ÿæˆ
4. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®åŸºæœ¬çš„ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥

### Phase 2: æœ€é©åŒ– âš¡
1. åˆ†å‰²ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè£…
2. IndexedDBã«ã‚ˆã‚‹æ°¸ç¶šåŒ–
3. å·®åˆ†æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ 
4. CDNæœ€é©åŒ–

### Phase 3: é«˜åº¦ãªæœ€é©åŒ– ğŸ”¥
1. Bloom Filterå®Ÿè£…
2. Trieæ§‹é€ ã«ã‚ˆã‚‹å€™è£œè¡¨ç¤º
3. æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹ä½¿ç”¨é »åº¦äºˆæ¸¬
4. å‹•çš„ãƒ‡ãƒ¼ã‚¿åœ§ç¸®

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- **åœ§ç¸®**: pako (gzip) ã¾ãŸã¯ brotli-wasm
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: IndexedDB (Dexie.js)
- **HTTP**: fetch API + Service Worker
- **åœ§ç¸®**: LZ4 / Snappy (é«˜é€Ÿåœ§ç¸®ãƒ»å±•é–‹)

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰/ã‚¤ãƒ³ãƒ•ãƒ©
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: Supabase Storage
- **CDN**: Cloudflare (Supabaseæ¨™æº–)
- **ãƒ“ãƒ«ãƒ‰**: Node.js scripts
- **åœ§ç¸®**: gzip, brotli, custom binary format

## äºˆæƒ³ã•ã‚Œã‚‹åŠ¹æœ

### 1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„
- **åˆæœŸãƒ­ãƒ¼ãƒ‰**: 600KB â†’ 180KB (70%å‰Šæ¸›)
- **æ¤œç´¢é€Ÿåº¦**: O(n) â†’ O(1) (æ–‡å­—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨)
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: å‹•çš„èª¿æ•´ã«ã‚ˆã‚Š50%å‰Šæ¸›

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š
- **é«˜é€Ÿèµ·å‹•**: 3ç§’ â†’ 1ç§’ä»¥ä¸‹
- **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ**: IndexedDBã‚­ãƒ£ãƒƒã‚·ãƒ¥
- **æ®µéšçš„ãƒ­ãƒ¼ãƒ‰**: å¿…è¦ãªåˆ†ã ã‘ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

### 3. é‹ç”¨åŠ¹ç‡åŒ–
- **ãƒ‡ãƒ¼ã‚¿æ›´æ–°**: å·®åˆ†æ›´æ–°ã«ã‚ˆã‚Šè»¢é€é‡å‰Šæ¸›
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: 10ä¸‡èªã¾ã§å¯¾å¿œå¯èƒ½
- **é–‹ç™ºåŠ¹ç‡**: è‡ªå‹•ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

## ãƒªã‚¹ã‚¯ãƒ»åˆ¶ç´„äº‹é …

### 1. æŠ€è¡“çš„ãƒªã‚¹ã‚¯
- **ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§**: IndexedDB, CompressionStreams
- **ãƒ¡ãƒ¢ãƒªåˆ¶é™**: ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã§ã®åˆ¶ç´„
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: ä½é€Ÿå›ç·šã§ã®åˆæœŸãƒ­ãƒ¼ãƒ‰

### 2. é‹ç”¨ãƒªã‚¹ã‚¯  
- **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã‚µãƒ¼ãƒãƒ¼ã®åŒæœŸ
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†**: ä¸‹ä½äº’æ›æ€§ã®ç¶­æŒ
- **éšœå®³å¯¾å¿œ**: Supabase Storageéšœå®³æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### å³åº§ã«å®Ÿæ–½å¯èƒ½
1. ç¾åœ¨ã®29èªãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å®Ÿè£…
2. Supabase Storageã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
3. åŸºæœ¬çš„ãªåœ§ç¸®ãƒ»å±•é–‹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…

### æ®µéšçš„å®Ÿæ–½
1. 4000èªãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ãƒ»æ•´ç†
2. æ–‡å­—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
3. åˆ†å‰²ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½å®Ÿè£…
4. IndexedDBã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…

---

**èª¿æŸ»çµè«–**: ãƒã‚¤ãƒŠãƒªåœ§ç¸® + Supabase Storage + äº‹å‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã‚Šã€4000èªè¦æ¨¡ã§ã‚‚é«˜é€Ÿãƒ»è»½é‡ãªè¾æ›¸ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿç¾ãŒå¯èƒ½ã€‚Phase 1ã‹ã‚‰æ®µéšçš„ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ãƒªã‚¹ã‚¯ã‚’æœ€å°åŒ–ã—ãªãŒã‚‰æœ€é©åŒ–ã‚’é€²ã‚ã‚‰ã‚Œã‚‹ã€‚

**æ¨å¥¨å®Ÿè£…**: æ–¹å¼1ï¼ˆãƒã‚¤ãƒŠãƒªåœ§ç¸®ï¼‰+ æ–¹å¼3ï¼ˆIndexedDBã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ§‹æˆã‚’åŸºæœ¬ã¨ã—ã€å¿…è¦ã«å¿œã˜ã¦æ–¹å¼2ï¼ˆåˆ†å‰²ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰ã‚’è¿½åŠ ã€‚
