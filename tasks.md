# Tasks: ITタイピングゲーム実装（制約システム対応）

## 📋 現状分析・課題洗い出し

### � 重大な仕様乖離（最優先対応）

#### 1. ゲームの根本的な仕様違い
**現状**: 指定された単語をローマ字で正確にタイピングする従来型ゲーム
**要件**: 文字制約条件（含む・始まる・終わる）に合致するIT用語を**自分で考えて**入力するゲーム

**影響範囲**:
- `frontend/app/game/page.tsx` のゲームロジック全体
- UI表示（現在の用語表示は削除、制約表示を主軸に）
- 入力検証システム（辞書照合 + 文字制約チェック）
- 得点計算式の実装

#### 2. 制約システムの未実装
**現状**: ダミーの制約表示のみ（実際の制約チェック機能なし）
**要件**: 文字制約システム実装が必要

**必要機能**:
- 文字制約（含む/始まる/終わる）
- 制約係数の管理・適用
- 動的難易度調整
- パス機能（10秒クールダウン）

#### 3. 得点計算式の実装不備
**現状**: `points = Math.floor(word.length * 1.5 * (combo + 1))`
**要件**: `獲得得点 = 単語文字数 × 難易度(1-10) × 制約係数の積 × コンボ数`

### 📁 関連ファイルパス

#### フロントエンド
- `frontend/app/game/page.tsx` - メインゲームロジック（大幅改修必要）
- `frontend/lib/database.types.ts` - 型定義（最新）
- `frontend/lib/supabase.ts` - Supabase接続設定

#### バックエンド・データベース
- `supabase/migrations/20250619_unified_schema.sql` - DBスキーマ（最新）
- `supabase/seed.sql` - サンプルデータ（最新）

#### 仕様・設計書
- `docs/plan.md` - 企画書（制約システム詳細）
- `docs/requirements.md` - 要件定義（機能詳細）

## 🎯 実装計画（段階別）

### Phase 1: 文字制約システム基盤構築
1. **制約データ管理**
   - 文字制約タイプ・制約係数のマスタデータ追加
   - 文字制約組み合わせパターンの事前定義
   
2. **制約生成・表示機能**
   - ランダム文字制約生成ロジック
   - 文字制約の可視化UI改善

### Phase 2: ゲームロジック改修
1. **入力検証システム**
   - IT用語辞書との照合機能
   - 文字制約条件チェック機能
   - 複数文字制約の組み合わせ対応

2. **得点計算式の正確な実装**
   - 難易度係数の取得・適用
   - 文字制約係数の積算
   - コンボ数の正確な反映

### Phase 3: UI/UX改善
1. **ゲーム画面の改修**
   - 現在の用語表示を削除
   - 文字制約表示の強化
   - ヘルプ・説明文の追加

2. **パス機能の実装**
   - 10秒クールダウンシステム
   - 文字制約変更ロジック

### Phase 4: 高度機能実装
1. **動的難易度調整**
   - プレイヤー成績に応じた文字制約選択
   - 上位/下位プレイヤー向け文字制約セット

2. **リアルタイム同期強化**
   - ゲーム状態の同期
   - プレイヤー間のスコア競争

## 🔧 技術的課題・検討事項

### データベース設計
- 文字制約マスタテーブルの追加検討
- 文字制約組み合わせパターンの保存方法
- 動的文字制約生成 vs 事前定義文字制約

### パフォーマンス
- リアルタイム辞書検索の最適化
- 文字制約チェック処理の効率化
- フロントエンド状態管理の改善

### ユーザビリティ
- 文字制約の分かりやすい表示方法
- 入力ヒント・補助機能
- エラーハンドリング・フィードバック改善

---

## ⚡ Next Actions

**最優先**: Phase 1 から順次実装開始
**デバッグ推奨**: 各Phase完了後にテスト・動作確認
**Git管理**: 各Phase完了時にsemantic commitでバージョン管理

## 完了項目 ✅
- [x] DBスキーマの統一（it_terms: display_text + romaji_text）
- [x] Seedデータの整理・厳選
- [x] TypeScript型定義の更新
- [x] フロントエンド基本データ取得の実装
- [x] ビルドエラーの修正
  display_text text not null,             -- 表示用テキスト（例：スクレイピング）
  romaji_text text not null unique,       -- ローマ字テキスト（例：sukureipingu）
  difficulty_id integer not null,
  description text,
  aliases text[] default '{}',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);
```

### データ例
```sql
-- 新しいデータ形式
('リアクト', 'riakuto', 2, 'フロントエンドライブラリ', array['React', 'ReactJS']),
('ジャバスクリプト', 'jabasukuriputo', 1, 'プログラミング言語', array['JavaScript', 'JS']),
('スクレイピング', 'sukureipingu', 2, 'ウェブデータ収集', array['scraping'])
```

### ゲーム機能での使い分け
- **表示**: `display_text` を使用（プレイヤーには日本語表示）
- **入力判定**: `romaji_text` でタイピング判定
- **制約システム**: `romaji_text` ベースで制約適用

### 影響範囲
- **データベース**: 
  - `/supabase/migrations/20250619_unified_schema.sql`
  - `/supabase/seed.sql`
- **型定義**: 
  - `/frontend/lib/database.types.ts`
- **ゲームロジック**:
  - `/frontend/app/game/page.tsx`
  - 制約システム関連ファイル（今後作成予定）

## 移行手順 🔄

1. スキーマ変更（ALTER TABLE）
2. 既存データの移行（display_text = term, romaji_text = term の暫定設定）
3. シードデータの更新
4. TypeScript型定義の更新
5. フロントエンドロジックの更新
6. 制約システムの対応確認

## 注意事項 ⚠️
- 既存データの互換性を保つため、段階的に移行
- ローマ字変換は手動で正確性を確保
- インデックスの再作成が必要
- Realtime機能への影響確認が必要

## 完了判定基準 ✅
- [ ] スキーマ変更完了
- [ ] 既存データ移行完了
- [ ] 新規サンプルデータ追加
- [ ] TypeScript型定義更新
- [ ] ゲーム画面での正常動作確認
- [ ] タイピング判定の正常動作確認
