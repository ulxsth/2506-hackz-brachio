# ゲーム時間短縮オプション追加 - 実装計画

## 📅 計画日時
2025年6月22日

## 🎯 要件
create-room画面で選択できるゲーム時間に短時間のテスト用オプションを追加する：
- 30秒 (テスト・デバッグ用)
- 1分 (クイックゲーム用)  
- 3分 (ショートゲーム用)

## 🔍 関連ファイル調査

### 1. create-room画面の特定 ✅
- `/frontend/app/create-room/page.tsx` - **発見済み**
- 現在の選択肢: 3分(3), 5分(5), 10分(10), 15分(15)
- Select要素で実装済み

### 2. 時間選択UIコンポーネント ✅
- `<Select>` コンポーネントを使用
- `timeLimit` state で管理 (デフォルト: 5分)
- オプション値は分単位で保存

### 3. データベース・バックエンド ✅
- ルーム作成時: `createRoom({ settings: { timeLimit, maxPlayers } })`
- ルーム画面: `currentRoom.settings.timeLimit` で参照
- `/frontend/lib/room.ts` で処理

### 4. ゲーム画面での時間反映 ❌
- `/frontend/app/game/page.tsx` の `timeLeft` は固定値 `300` (5分)
- **問題**: ルーム設定の時間が反映されていない
- **要修正**: currentRoom.settings.timeLimit から初期化が必要

## 📝 実装タスク

### Phase 1: 調査 🔍
- [x] create-room画面のファイル特定
- [x] 現在の時間選択UIの実装確認
- [x] 時間設定の保存・取得フロー確認
- [x] データベーススキーマの確認
- [x] **重要**: ゲーム画面の時間初期化バグを発見

### Phase 2: UI修正 🎨
- [x] 時間選択オプションに短時間を追加
  - 30秒 (0.5)
  - 1分 (1) 
  - 3分 (3) ← 既存
- [x] UIの表示順序調整（短時間→長時間）
- [x] テスト用表示削除（シンプル化）

### Phase 3: バックエンド対応 ⚙️
- [x] **優先**: ゲーム画面の時間初期化修正
- [x] バリデーション追加（最小0.5分〜最大制限）

### Phase 4: テスト 🧪
- [ ] 30秒ゲームの動作確認
- [ ] 1分ゲームの動作確認  
- [ ] 3分ゲームの動作確認
- [ ] 従来の長時間ゲーム動作確認

## 🚨 発見した問題
**ゲーム画面の時間初期化バグ**: 
- 現在 `timeLeft` は固定値300秒(5分)でハードコード
- ルーム設定の `timeLimit` が反映されていない
- この修正も同時に実装が必要

## 🚫 制約・注意事項
- 短時間ゲームはテスト・デバッグ目的
- 最小時間は30秒に制限
- 既存の長時間オプションは維持

## 🎯 完了条件
- create-room画面で30s/1m/3mが選択可能
- 選択した時間でゲームが正常に動作
- ゲーム終了時に結果画面に正常遷移
- 既存機能に影響なし

---
作成者: GitHub Copilot  
目的: テスト・デバッグ効率化
緊急度: 中
- **プレイヤー入力**: 表示された単語を正確にタイピング
- **判定**: 完全一致による正誤判定
- **得点係数**: タイピング速度に基づく係数（1.0-3.0）

#### 制約ターン
- **出題方式**: 指定文字（例："r"を含む単語を入力してください）
- **プレイヤー入力**: 制約条件を満たすIT用語を考えて入力
- **判定**: 辞書照合 + 制約条件チェック
- **得点係数**: 制約文字の希少性による係数（2-8）

### 得点システム
- **ゲーム終了条件**: 制限時間到達
- **勝利条件**: 最も高い得点を獲得したプレイヤーが勝利

### 得点システム
- **得点条件**: 辞書内に存在し、提示された指定文字を含む単語の入力

### 得点計算式
**通常ターン**:
```
獲得得点 = 単語文字数 × 難易度(1-10) × タイピング速度係数(1.0-3.0) × コンボ数
```

**制約ターン**:
```
獲得得点 = 単語文字数 × 難易度(1-10) × 制約係数(2-8) × コンボ数
```

- **難易度**: 単語の普遍性による（1-10の範囲）
- **タイピング速度係数**（通常ターン用）: 入力時間による動的係数（1.0-3.0の範囲）
  - 高速入力例: 1秒以内 → 係数3.0
  - 標準入力例: 3秒以内 → 係数2.0
  - 低速入力例: 5秒以上 → 係数1.0
- **制約係数**（制約ターン用）: 指定文字制約の動的係数（2-8の範囲）
  - 一般的文字例: "aを含む" → 係数2、"eを含む" → 係数2
  - 中程度文字例: "rを含む" → 係数3、"sを含む" → 係数3  
  - 希少文字例: "xを含む" → 係数7、"zを含む" → 係数8

### 制約システム（制約ターン用）
- **制約タイプ**: 「指定文字を含む」のみ
  - ランダムに選ばれたアルファベット一文字を含む単語（例：「r」→「react」「server」「jar」）
- **制約の組み合わせ**: 指定文字制約のみのシンプル設計
  - 辞書内に指定文字を含むIT用語が十分存在することを保証
- **動的難易度調整**: 文字の出現頻度による係数変動
- **パス機能**: 制約変更が可能（使用制限なし、クールダウン10秒）
  - 新しいランダム文字での制約生成
  - 制約ターンでのみ使用可能

### コンボシステム
- **上限値**: なし（無制限）
- **コンボリセット条件**:
  - 時間経過（10秒間入力なし）
  - 不正解入力
  - パス使用時
- パスを使用せずに連続で正解した場合、コンボ数が加算

### マッチング・ルームシステム
- **ルーム作成フロー**:
  1. ホストがあいことば（例：hoge123）を設定して部屋作成
  2. 参加者があいことばを入力して部屋に参加
  3. 全員揃ったらホストが「スタート」ボタンでゲーム開始
- **途中参加・退出**: 対応しない（ゲーム中の参加・退出は処理しない）

---

### 技術仕様

#### データベース拡張
- **turn_type**フィールドを追加：'typing' | 'constraint'
- **target_word**フィールドを追加：通常ターン用の提示単語
- **constraint_char**フィールドを追加：制約ターン用の指定文字
- **turn_start_time**フィールドを追加：タイピング速度計算用

#### ゲームロジック
- **ターン生成ロジック**: Math.random() < 0.83 ? 'typing' : 'constraint'
- **単語選択ロジック**: IT用語辞書からランダム選択（通常ターン用）
- **制約文字生成**: アルファベット26文字から重み付きランダム選択
- **タイピング速度計算**: (turn_end_time - turn_start_time) / 1000 秒

#### フロントエンド拡張
- **ターン表示UI**: ターンタイプに応じた異なる表示
- **通常ターン**: 「この単語をタイピングしてください: {target_word}」
- **制約ターン**: 「'{constraint_char}'を含むIT用語を入力してください」
- **パスボタン**: 制約ターンでのみ表示・有効

